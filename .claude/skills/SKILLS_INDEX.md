# Skills Index — Lazy Loading Router

> **КРИТИЧНО:** НЕ загружай все скиллы. Читай только нужные для текущей задачи.

---

## Интеграция с OpenSpec

OpenSpec управляет **ЧТО** делать (proposal → tasks → archive).  
Skills управляют **КАК** делать (TDD, debugging, verification).

```
┌─────────────────────────────────────────────────────────────┐
│                      ЗАПРОС                                 │
└─────────────────────────────────────────────────────────────┘
                          │
        ┌─────────────────┼─────────────────┐
        ▼                 ▼                 ▼
   ┌─────────┐      ┌──────────┐      ┌─────────┐
   │ OpenSpec│      │  Skills  │      │  Both   │
   │  Only   │      │   Only   │      │         │
   └─────────┘      └──────────┘      └─────────┘
   
   • proposal       • bug/fix         • implement
   • spec           • refactor        • continue
   • plan change    • debug           • finish
   • new feature    • test
```

---

## Когда что использовать

| Запрос содержит | Действие |
|-----------------|----------|
| `proposal`, `spec`, `plan change`, `новая фича` | → `openspec/AGENTS.md` (Stage 1), **Skills НЕ нужны** |
| `implement`, `continue`, `выполни tasks.md` | → OpenSpec Stage 2 + Skills |
| `archive`, `завершить change` | → `openspec/AGENTS.md` (Stage 3), Skills НЕ нужны |
| `bug`, `fix`, `ошибка`, `не работает` | → **Анализ сложности → 1-3 скилла** (не только debugging!) |
| `refactor`, `optimize` (малый scope) | → **Анализ сложности → 1-3 скилла** |

---

## OpenSpec Stage 1: Proposal

**Skills НЕ используются на этапе планирования.**

Proposal — это документация (proposal.md, tasks.md, design.md), не код.
Скиллы нужны только для реализации и фиксов.

---

## OpenSpec Stage 2: Implementation + Skills

Когда proposal approved и ты на стадии Implementation:

```
1. Прочитай proposal.md — что делаем
2. Прочитай design.md (если есть) — как делаем
3. Прочитай tasks.md — чеклист задач

4. ЗАГРУЗИ SKILLS INDEX:
   cat .claude/skills/SKILLS_INDEX.md

5. ДЛЯ КАЖДОЙ ЗАДАЧИ из tasks.md:
   → Выбери 1-3 скилла из индекса
   → Загрузи: cat .claude/skills/<папка>/SKILL.md
   → Выполни задачу по скиллу
   → Отметь [x] в tasks.md

6. После всех задач:
   → verification-before-completion
   → finishing-a-development-branch
   → openspec archive (Stage 3)
```

---

## Скиллы по фазам

### Phase: Implementation (выполнение tasks.md)

| Скилл | Когда | Путь |
|-------|-------|------|
| **executing-plans** | Выполнение плана батчами с ревью | `executing-plans/SKILL.md` |
| **subagent-driven-development** | Независимые задачи, параллельная работа | `subagent-driven-development/SKILL.md` |
| **test-driven-development** | ⚠️ ВСЕГДА при написании кода | `test-driven-development/SKILL.md` |
| **using-git-worktrees** | Нужна изоляция для фичи | `using-git-worktrees/SKILL.md` |

---

### Phase: Debugging (при ошибках)

| Скилл | Когда | Путь |
|-------|-------|------|
| **systematic-debugging** | ⚠️ ЛЮБОЙ баг — СНАЧАЛА этот | `systematic-debugging/SKILL.md` |
| **root-cause-tracing** | Ошибка глубоко в стеке | `root-cause-tracing/SKILL.md` |
| **defense-in-depth** | Баг от невалидных данных | `defense-in-depth/SKILL.md` |
| **dispatching-parallel-agents** | 3+ независимых фейла | `dispatching-parallel-agents/SKILL.md` |

---

### Phase: Testing (качество тестов)

| Скилл | Когда | Путь |
|-------|-------|------|
| **testing-anti-patterns** | Пишу/меняю тесты | `testing-anti-patterns/SKILL.md` |
| **condition-based-waiting** | Flaky тесты, race conditions | `condition-based-waiting/SKILL.md` |

---

### Phase: Review (проверка кода)

| Скилл | Когда | Путь |
|-------|-------|------|
| **requesting-code-review** | Закончил задачу, нужен ревью | `requesting-code-review/SKILL.md` |
| **receiving-code-review** | Получил фидбек | `receiving-code-review/SKILL.md` |

---

### Phase: Completion (перед archive)

| Скилл | Когда | Путь |
|-------|-------|------|
| **verification-before-completion** | ⚠️ ПЕРЕД любым "готово" | `verification-before-completion/SKILL.md` |
| **finishing-a-development-branch** | Мерж, PR, завершение ветки | `finishing-a-development-branch/SKILL.md` |

---

## ⚠️ Обязательные скиллы

| Ситуация | Действие | Почему |
|----------|----------|--------|
| Любой баг/фикс | **Анализ сложности → 1-3 скилла** | Не только debugging! Сложный фикс требует TDD, code-review |
| Любой новый код | `test-driven-development` + другие по необходимости | Без теста — код не верифицирован |
| **После КАЖДОЙ правки** | **Тестирование + анализ логов** | Без проверки результата — не факт что работает |
| Написание тест-скриптов | **Скиллы если нужен код** (TDD, testing-anti-patterns) | Тест-код = код → применяй скиллы |
| Заявление "готово" | `verification-before-completion` | Без проверки — не факт |
| Все задачи в tasks.md выполнены | `finishing-a-development-branch` | Правильное завершение |

---

## ⚠️ ОБЯЗАТЕЛЬНОЕ ТЕСТИРОВАНИЕ ПОСЛЕ КАЖДОЙ ПРАВКИ

**Это правило НЕ пропускается. Никогда.**

### Когда тестировать

- После КАЖДОЙ правки кода
- После КАЖДОГО фикса
- После КАЖДОЙ реализации задачи из tasks.md
- После работы субагента — субагент тестирует свою часть
- После каждой сессии (если работа разбита на сессии)

### Алгоритм тестирования

```
ПОСЛЕ КАЖДОЙ ПРАВКИ:

1. НАПИСАТЬ ТЕСТ-СКРИПТ
   → Пишешь скрипт/программу для тестирования конкретного изменения
   → Не "работает ли сервис в целом", а именно ЭТА правка
   → Разрешено писать любые скрипты, утилиты, тесты

2. ЗАПУСТИТЬ ТЕСТ
   → Выполнить тест на реальной ситуации
   → Собрать логи выполнения

3. АНАЛИЗ ЛОГОВ
   → Прочитать логи детально
   → Найти результат выполнения

4. СРАВНЕНИЕ С ТЗ
   → Взять исходный запрос / proposal / design / tasks.md
   → Сравнить ожидаемый результат с фактическим

5. ВЫВОД
   ├─ Результат СОВПАДАЕТ с ожиданием → Задача выполнена ✓
   └─ Результат НЕ совпадает → Внести правки → Повторить с шага 1
```

### Что сравнивать

| Источник ТЗ | Где взять |
|-------------|-----------|
| Запрос пользователя | Исходное сообщение в чате |
| OpenSpec proposal | `proposal.md` — секция "What Changes" |
| OpenSpec design | `design.md` — ожидаемое поведение |
| Задача | `tasks.md` — конкретный пункт чеклиста |
| Баг-репорт | Описание бага и ожидаемое поведение |

### Формат вывода после теста

```
## Результат тестирования

**Изменение:** [что было изменено]
**Тест:** [как тестировал — скрипт, команда, сценарий]
**Ожидание (из ТЗ):** [что должно было произойти]
**Факт (из логов):** [что произошло на самом деле]
**Статус:** ✓ Совпадает / ✗ Не совпадает

[Если не совпадает — что нужно исправить]
```

### Пример цикла

```
Задача: Добавить валидацию email в форму регистрации

1. Написал код валидации
2. Написал тест-скрипт: curl с невалидным email
3. Запустил, получил логи
4. Ожидание (из tasks.md): "возвращать ошибку 400 с сообщением"
5. Факт (из логов): вернулся 200 OK
6. НЕ совпадает → исправляю код → повторяю тест
7. Факт (из логов): вернулся 400 с сообщением
8. Совпадает ✓ → задача выполнена
```

### Скиллы для тест-скриптов

Если тест требует написания кода — применяй скиллы как для любого кода:

| Ситуация | Скиллы |
|----------|--------|
| Простой curl/запрос | Не нужны |
| Тест с логикой | `test-driven-development` |
| Сложные моки/стабы | `testing-anti-patterns` |
| Тест с race conditions | `condition-based-waiting` |

**Тест-код = код. К нему те же правила.**

### Запрещено

- Пропускать тестирование ("и так работает")
- Тестировать "в голове" без реального запуска
- Отмечать задачу выполненной без теста
- Игнорировать несовпадение результата с ТЗ
- **Писать тест-код без скиллов когда они нужны**

---

## Типичные сценарии

### Новая фича (полный цикл)

```
STAGE 1 — OpenSpec (без скиллов):
  openspec/AGENTS.md → создать proposal
  → proposal.md, tasks.md, design.md (документация)
  → дождаться approval
  → Skills НЕ нужны

STAGE 2 — Implementation (со скиллами):
  using-git-worktrees (изоляция)

  Для КАЖДОЙ задачи:
    1. test-driven-development → написать код
    2. ⚠️ ТЕСТ → скрипт/команда для проверки именно этого изменения
    3. ⚠️ АНАЛИЗ ЛОГОВ → сравнить с tasks.md
    4. Если НЕ совпадает → исправить → повторить тест
    5. Отметить [x] в tasks.md

  После ВСЕХ задач:
    verification-before-completion
    finishing-a-development-branch

STAGE 3 — OpenSpec (без скиллов):
  openspec archive <change-id> --yes
```

### Баг-фикс (без OpenSpec)

```
1. АНАЛИЗ СЛОЖНОСТИ фикса
   → Простой (опечатка, очевидная ошибка): 1 скилл
   → Средний (логика, валидация): 2 скилла
   → Сложный (архитектура, рефакторинг): 3 скилла

2. ВЫБОР СКИЛЛОВ (примеры):
   → Простой: systematic-debugging
   → Средний: systematic-debugging + TDD
   → Сложный: systematic-debugging + TDD + code-review

3. ВЫПОЛНЕНИЕ:
   → Найти root cause
   → Написать failing test
   → Исправить

4. ⚠️ ТЕСТ → скрипт для проверки фикса
   → Если тест-скрипт требует кода → применить скиллы!

5. ⚠️ АНАЛИЗ ЛОГОВ → сравнить с описанием бага

6. Если НЕ совпадает → исправить → повторить

7. verification-before-completion → проверить
```

### Продолжить implementation

```
1. openspec show <change-id> → понять контекст
2. Прочитать tasks.md → найти незавершённые задачи
3. cat .claude/skills/SKILLS_INDEX.md
4. Выбрать скиллы для текущей задачи
5. Продолжить работу
```

---

## Мета-скиллы

| Скилл | Когда | Путь |
|-------|-------|------|
| **using-superpowers** | Начало сессии, определение скиллов | `using-superpowers/SKILL.md` |
| **writing-skills** | Создание нового скилла | `writing-skills/SKILL.md` |
| **testing-skills-with-subagents** | Тестирование скилла | `testing-skills-with-subagents/SKILL.md` |
| **sharing-skills** | Контрибьют скилла в upstream | `sharing-skills/SKILL.md` |

---

## Правила

1. **Максимум 3 скилла** одновременно
2. **OpenSpec первый** для новых фич (Stage 1 → Stage 2)
3. **Skills для HOW** — OpenSpec для WHAT
4. **SUB-SKILL ссылки** — если скилл требует другой, загрузи его
5. **Не загружай заранее** — только по необходимости
